```{r setup, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

# Adolescent Weight Trajectory Vignette

```{r}
library(fable)
library(ggplot2)
library(dplyr)
library(stringr)
library(gridExtra)
source('R/bmiz_to_bmi.R')
source('R/solve_for_wt.R')
source('R/logit_transform.R')
bmi_data <- readxl::read_excel('test_data/test-data.3.xlsx') 
  
```

Below I give an example of prediction of adolescent growth for three individuals with varying amounts of childhood growth chart data. The vignette includes three steps:

1)  Coding, modeling and prediction of BMI-Z scores

2)  Transforming BMI-Z scores back to interpretable, individualized BMI graphs

3)  Using adult height data, if available, to project weight across adolescence.

### Step 1: Coding and Modeling BMI-Z from Growth Charts

In the first step, growth chart inputs (height and weight) are converted to BMI-Z score, which is plotted across childhood along with the mean BMI-Z and 95% confidence band for this mean. After all available BMI-Z scores are input, prediction of future BMI-Z is forecast which accounts for recent measures of and variability in BMI-Z to forecast a BMI-Z moving forward. Further, the overall number of observations and variance in previous BMI-Z to create a prediction window for future observations. This prediction window widens over time to account for the fact that we are more confident in observations that are more proximal to the last measurement. While prediction is currently most influenced by those taken at oldest ages (and assume that measurements are taken before ED symptom onset), an alternative model might specify that the highest BMIz scores -- regardless of age -- define prediction.

In the following example, participant 1 has routine observations from age 12, with BMI-Z trending slightly up over time. Participant 2 has routine observations from 5-15 centering around a BMI-Z of \~ 0.5, and participant 3 has only four observations all at a young age. Thus, as we move towards age 20, the prediction window for participant 3 is the largest of the three participants.

```{r}

## Add in acutal BMI data for later plotting
bmi_data <- bmi_data |> 
    mutate(bmi_real = bmi_lookup_cdc(age = age*12, bmiz = bmiz, sex = 2)) |> 
    mutate(agemos = round(age *12, 0)) |> 
    mutate(participant = recode(bmi_data$participant, '1' = 'Youth #1 - Average, Sparse data', '2' = 'Youth #2 - Low Average, Moderate Variability', '3' = 'Youth #3 - High Average, Stable' ))

# makes a tsibble object with existing data. This object has ONLY Age in months, BMIz scores (at months assessed) and participant number
ts_data <- bmi_data |> 
  select(-c(age, adult_ht_in)) |> 
  as_tsibble(index = agemos, key = participant) |> 
  tsibble::fill_gaps() 


#creates fit data based on a few models
bmiz_fit <- ts_data |> 
  model(Mean = MEAN(bmiz), #Mean of all measurements
        Linear = TSLM(my_scaled_logit(bmiz, lower = -2, upper = 3) ~ agemos), # A linear model which uses a scaled logit model with upper and lower bounds
        arima = ARIMA(bmiz ~ pdq(0,1,0))) %>%  # A 'Naive' Model which uses the last observation and includes a random walk from the last obs
  mutate(C1 = (Mean  + arima + Linear)/3) |> # Note to self - CIs on the linear model don't play well with CIs on the ARIMA and mean models given the scaled logit model. Can't figure out how to combine them with good SEs, but the trajectories themselves look plausible for this model
  mutate(C2 = (arima + Mean)/2) |> #Combines the RW model with the Mean model, such that predictions are pulled between the mean and the
  forecast(h = 220)  %>% #forecasts across 220 months - e.g. from three years old 
  filter(agemos <252) #removes ages > 20, assumes 20.9 is terminal age

#Creates Graph of BMIZ forecasts for three youth in Vingette
bmiz_fit |> 
  filter(.model == 'C2') |> 
  autoplot(ts_data, level = 99) +
  geom_point(x = ts_data$agemos, y = ts_data$bmiz) +
  scale_x_continuous(breaks = 12*0:240, label = m2y(12*0:240)) + #Labels x scale in Years instead of months
  xlab('Age') + 
  ylab('BMI Z-Score') +
  ggtitle(str_wrap('BMIZ Forecasts for Three Youth with Varying BMIZ Trends and Avaliable Childhood Data: Mean + Random Walk from Most Recent Data - 80% prediction interval', width = 70)) +
  theme(legend.position = 'none')

ggsave('bmiz_3youth.png')
```

### Step 2: Back-translation to BMI

The below graphs back translate these BMI-Z forecasts to actual BMI numbers over time, using an 80% confidence band from the previous mode

```{r}


agemos = c(36:240)
median_bmi_by_age <- tibble(agemos) |> 
  mutate(bmi = bmi_lookup_cdc(2, agemos, 0))  %>% 
  mutate(adult_height = 65) |> 
  mutate(median_wt = if_else(agemos > 14*12, solve_for_weight(bmi, adult_height), NaN)) |> 
  mutate(AN_cutoff = median_wt*0.85)


fcast <- bmiz_fit %>% 
  filter(.model == 'C2') |> 
  hilo(level = c(80, 95))  |> 
  mutate(adult_height = 65) #note - adult height here set at 65 in for all participants for the vignette purposes

fcast <- fcast %>% 
 mutate(bmi = bmi_lookup_cdc(age = agemos, bmiz = .mean, sex = 2)) %>% 
 mutate(weight = solve_for_weight(bmi = bmi, height = adult_height)) %>% 
 mutate(bmiz_lower = fcast$`80%`$lower) %>% 
 mutate(bmiz_upper = fcast$`80%`$upper) %>% 
 mutate(weight = solve_for_weight(bmi = bmi, height = adult_height)) %>% 
 mutate(bmi_lower = bmi_lookup_cdc(age = agemos, bmiz = bmiz_lower, sex = 2)) %>% 
 mutate(weight_lower = solve_for_weight(bmi = bmi_lower, height = adult_height)) %>% 
 mutate(bmi_upper = bmi_lookup_cdc(age = agemos, bmiz = bmiz_upper, sex = 2)) %>% 
 mutate(weight_upper = solve_for_weight(bmi = bmi_upper, height = adult_height)) 

fcast_bypx <- split.data.frame(fcast, fcast$participant)

x <- vector(mode = 'list', length = length(unique(bmi_data$participant)))
i = 1
bmi_data_bypx <- split.data.frame(bmi_data, bmi_data$participant)


while (i <= length(unique(bmi_data$participant))) {

x[[i]] <- ggplot(data = fcast_bypx[[i]], mapping = aes(x = agemos, y = bmi)) +
  geom_point(mapping = aes(agemos, bmi_real), data = bmi_data_bypx[[i]], stat = 'identity', position = 'identity') +
  stat_smooth(mapping = aes(x = agemos, y = bmi_real), method = lm, formula = y~x + poly(x,2) + poly(x,3), linetype = 'dotted', col = 'coral2', data = bmi_data_bypx[[i]], se = FALSE) + 
  stat_smooth(mapping = aes(x = agemos, y = bmi_upper), col = 'purple', linetype = 'dashed', data = fcast_bypx[[i]],  position = 'identity' ) +
  stat_smooth(mapping = aes(x = agemos, y = bmi_lower), col = 'purple', linetype = 'dashed', data = fcast_bypx[[i]],  position = 'identity' ) + 
  stat_smooth(mapping = aes (x = agemos, y = bmi), data = fcast_bypx[[i]]) + 
  scale_x_continuous(breaks = 12*0:240, label = m2y(12*0:240)) +
  xlab('Age') + 
  ylab('BMI') 
  i = i+1 }

do.call(grid.arrange, c(x, nrow = 2))
```

### Step 3: Using expected or obtained adult height to predict weight change over adolescence

The following graphs use an expected or measured adult height to then depict predicted weights from ages 14-20 for each participant.In the current vignette, participant 1's adult height is 64 inches, participant 2's adult height is 68 inches, and participant 3's adult height is 70.2 inches. Note that participant 2's predicted weights begin at 15.1 as they had an actual weight entered at 15 years.

```{r}

#makes new data including only adolescent time frame
fcast_adolescence <- 
  fcast |> 
  filter(agemos >179)

fcast_adolescence <- split.data.frame(fcast_adolescence, fcast_adolescence$participant)
  
y <- vector(mode = 'list', length = length(unique(bmi_data$participant)))

i = 1
while (i <= length(unique(bmi_data$participant))) {

y [[i]] <- ggplot() +
  stat_smooth(mapping = aes(x = agemos, y = weight_upper), col = 'purple', linetype = 'dashed', data = fcast_adolescence[[i]], stat = 'identity', position = 'identity' ) +
  stat_smooth(mapping = aes(x = agemos, y = weight_lower), col = 'purple', linetype = 'dashed', data = fcast_adolescence[[i]], stat = 'identity', position = 'identity' ) + 
  stat_smooth(mapping = aes (x = agemos, y = weight), data = fcast_adolescence[[i]]) +
  stat_smooth(mapping = aes(x = agemos, y = median_wt), col = 'orange', linetype = 'dotted', data = median_bmi_by_age, stat = 'identity', position = 'identity')+
    stat_smooth(mapping = aes(x = agemos, y = AN_cutoff), col = 'red', linetype = 'dotted', data = median_bmi_by_age, stat = 'identity', position = 'identity' )+
    scale_x_continuous(breaks = 12*0:240, label = m2y(12*0:240), limits = c(180, 240)) +
  ylab('Predicted Weight') + 
  xlab('Age')
  
i = i+1 
}

do.call(grid.arrange, c(y, nrow = 2))

```

Based on this information, one can look up predicted weights at a specific age, along with upper and lower confidence bands using a lookup function, as seen below.

**Projected weights at age 16 years:**

```{r}
l <- length(unique(fcast$participant))
wt <- vector(mode = 'list', length  = l)
p_list <- as.list(unique(fcast$participant))


i = 1
while (i <= l) {
wt[[i]] <- wt_lookup_by_age( p_list[i], 16*12, fcast)
i = i + 1
}

wt

```
